AWSTemplateFormatVersion: "2010-09-09"
Description: APP creation and configuration

Parameters:
    RdsAddress: 
      Type: String
    RdsPort:
      Type: String
    BucketName: 
      Type: String
    AccessKeyID: 
      Type: String
    SecretAccessKey: 
      Type: String
    DirectusUsername:
      Type: AWS::SSM::Parameter::Value<String>
      Default: DIRECTUS_DATABASE_USERNAME
    DirectusPassword:
      Type: AWS::SSM::Parameter::Value<String>
      Default: DIRECTUS_DATABASE_PASSWORD
    DirectusDatabaseName:
      Type: AWS::SSM::Parameter::Value<String>
      Default: DIRECTUS_DATABASE_NAME
    DirectusClient:
      Type: AWS::SSM::Parameter::Value<String>
      Default: DIRECTUS_DATABASE_CLIENT

Resources:
  AppSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: For ssh on port 22 access and 8080 port access for App
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: "8080"
          ToPort: "8080"
          CidrIp: 0.0.0.0/0

  App:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0333305f9719618c7
      KeyName: Directus
      SecurityGroups:
        - !Ref AppSG
      UserData: 
        Fn::Base64: !Sub
           | 
            #!/bin/bash

            sudo bash

            sudo apt-get update
            sudo apt install docker.io
            sudo snap install docker

            # Clone and run a sample application
            mkdir projects
            cd projects/
            git clone https://github.com/francoislongatte/Directus.git
            cd Directus

            export DIRECTUS_DATABASE_HOST=${RdsAddress}
            export DIRECTUS_DATABASE_PORT=${RdsPort}
            export DIRECTUS_DATABASE_CLIENT=${DirectusClient}
            export DIRECTUS_DATABASE_NAME=${DirectusDatabaseName}
            export DIRECTUS_DATABASE_PASSWORD=${DirectusPassword}
            export DIRECTUS_DATABASE_USERNAME=${DirectusUsername}
            export DIRECTUS_KEY={{resolve:ssm-secure:DIRECTUS_KEY:1}}
            export DIRECTUS_SECRET={{resolve:ssm-secure:DIRECTUS_SECRET:1}}
            export ADMIN_EMAIL={{resolve:ssm-secure:ADMIN_EMAIL:1}}
            export ADMIN_PASSWORD={{resolve:ssm-secure:ADMIN_PASSWORD:1}}
            export STORAGE_S3_KEY=${AccessKeyID}
            export STORAGE_S3_SECRET=${SecretAccessKey}
            export STORAGE_S3_BUCKET=${BucketName}
            export STORAGE_LOCATIONS=s3
            export STORAGE_S3_DRIVER=s3
            export STORAGE_S3_REGION=eu-west-1

            docker-compose --file docker-compose.yaml up

Outputs:
  PublicIp:
    Value: !GetAtt App.PublicIp